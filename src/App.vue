<script setup>
import { computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useAuthStore } from './stores/auth'
import UserProfileMenu from './components/profile/UserProfileMenu.vue'

const router = useRouter()
const route = useRoute()
const auth = useAuthStore()

const role = computed(() => auth.role)
const isAuthed = computed(() => auth.isAuthenticated)
// Only treat pure login route as auth shell; register is now an in-app admin view
const isLoginRoute = computed(() => route.path === '/login')

function go(path) {
  router.push(path)
}
function logout() {
  auth.logout()
  router.push('/login')
}

function navClasses(active) {
  return [
    'px-3','py-2','rounded-md','text-sm','font-medium','transition-colors','select-none',
    active
      ? 'bg-slate-300 text-slate-1000 shadow-sm'
      : 'text-slate-700 hover:bg-slate-200 hover:text-slate-900'
  ].join(' ')
}
</script>

<template>
  <div>
    <RouterView v-if="isLoginRoute" />
    <div v-else class="min-h-screen flex flex-col bg-slate-100 text-gray-800">
      <header class="bg-white/90 backdrop-blur border-b border-slate-200 shadow-sm">
        <div class="max-w-[1700px] mx-auto pl-12 pr-12 py-3 flex items-center gap-24">
          <h1 @click="go('/claims')" class="text-2xl font-bold cursor-pointer select-none tracking-tight flex items-center gap-1" title="Go to claims">
            <span class="text-blue-600">Claims<span class="text-slate-800">GT</span></span>
          </h1>
          <nav class="flex-1 flex items-center gap-3" v-if="isAuthed">
            <RouterLink v-if="role!=='finance' && role!=='employee'" to="/claims" v-slot="{ isActive }">
              <span :class="navClasses(isActive)">Claims</span>
            </RouterLink>
            <RouterLink v-if="role==='manager' || role==='admin'" to="/manager" v-slot="{ isActive }">
              <span :class="navClasses(isActive)">Team Claims</span>
            </RouterLink>
            <RouterLink v-if="role==='finance' || role==='admin'" to="/finance" v-slot="{ isActive }">
              <span :class="navClasses(isActive)">Reimbursement</span>
            </RouterLink>
            <RouterLink v-if="role==='finance' || role==='admin'" to="/claim-limits" v-slot="{ isActive }">
              <span :class="navClasses(isActive)">Claim Limits</span>
            </RouterLink>
            <RouterLink v-if="role==='admin' || role==='finance'" to="/config" v-slot="{ isActive }">
              <span :class="navClasses(isActive)">Config</span>
            </RouterLink>
            <RouterLink v-if="role==='admin'" to="/register" v-slot="{ isActive }">
              <span :class="navClasses(isActive)">User Management</span>
            </RouterLink>
          </nav>
          <div v-else-if="isAuthed" class="flex-1"></div>
          <div class="flex items-center gap-4">
            <RouterLink v-if="!isAuthed" to="/login" class="text-sm bg-blue-600 hover:bg-blue-700 active:bg-blue-800 shadow text-white px-4 py-2 rounded-md font-medium transition-colors">Login</RouterLink>
            <UserProfileMenu v-else :user="auth.user" @logout="logout" />
          </div>
        </div>
      </header>
      <main class="flex-1 w-full mx-auto max-w-[1650px] px-12 pt-10 pb-14">
        <div class="bg-white rounded-lg shadow border border-slate-200 min-h-[60vh] p-10">
          <RouterView />
        </div>
      </main>
      <footer class="text-center text-xs text-slate-500 py-6">Â© {{ new Date().getFullYear() }} ClaimsGT</footer>
    </div>
  </div>
</template>

<style>
</style>
